from __future__ import annotations

import base64
import os
from datetime import datetime, timezone
from pathlib import Path

from fastapi import APIRouter

from schemas import TelemetryPacket, TriggerKind
from core.planner import handle_prevention, handle_incident

router = APIRouter(prefix="/api/demo", tags=["demo"])

DEMO_DIR = Path(__file__).parent.parent / "demo_assets"


def _load_frames(subdir: str) -> list[str]:
    """Load JPEG frames from demo_assets as base64 strings."""
    frames_dir = DEMO_DIR / subdir
    frames = []
    if frames_dir.exists():
        for f in sorted(frames_dir.glob("*.jpg")):
            frames.append(base64.b64encode(f.read_bytes()).decode())
    if not frames:
        frames = [_placeholder_frame()]
    return frames


def _placeholder_frame() -> str:
    """Generate a tiny valid JPEG as placeholder (1x1 red pixel)."""
    # Minimal JPEG: 1x1 pixel
    raw = bytes([
        0xFF, 0xD8, 0xFF, 0xE0, 0x00, 0x10, 0x4A, 0x46,
        0x49, 0x46, 0x00, 0x01, 0x01, 0x00, 0x00, 0x01,
        0x00, 0x01, 0x00, 0x00, 0xFF, 0xDB, 0x00, 0x43,
        0x00, 0x08, 0x06, 0x06, 0x07, 0x06, 0x05, 0x08,
        0x07, 0x07, 0x07, 0x09, 0x09, 0x08, 0x0A, 0x0C,
        0x14, 0x0D, 0x0C, 0x0B, 0x0B, 0x0C, 0x19, 0x12,
        0x13, 0x0F, 0x14, 0x1D, 0x1A, 0x1F, 0x1E, 0x1D,
        0x1A, 0x1C, 0x1C, 0x20, 0x24, 0x2E, 0x27, 0x20,
        0x22, 0x2C, 0x23, 0x1C, 0x1C, 0x28, 0x37, 0x29,
        0x2C, 0x30, 0x31, 0x34, 0x34, 0x34, 0x1F, 0x27,
        0x39, 0x3D, 0x38, 0x32, 0x3C, 0x2E, 0x33, 0x34,
        0x32, 0xFF, 0xC0, 0x00, 0x0B, 0x08, 0x00, 0x01,
        0x00, 0x01, 0x01, 0x01, 0x11, 0x00, 0xFF, 0xC4,
        0x00, 0x1F, 0x00, 0x00, 0x01, 0x05, 0x01, 0x01,
        0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x03, 0x04,
        0x05, 0x06, 0x07, 0x08, 0x09, 0x0A, 0x0B, 0xFF,
        0xC4, 0x00, 0xB5, 0x10, 0x00, 0x02, 0x01, 0x03,
        0x03, 0x02, 0x04, 0x03, 0x05, 0x05, 0x04, 0x04,
        0x00, 0x00, 0x01, 0x7D, 0x01, 0x02, 0x03, 0x00,
        0x04, 0x11, 0x05, 0x12, 0x21, 0x31, 0x41, 0x06,
        0x13, 0x51, 0x61, 0x07, 0x22, 0x71, 0x14, 0x32,
        0x81, 0x91, 0xA1, 0x08, 0x23, 0x42, 0xB1, 0xC1,
        0x15, 0x52, 0xD1, 0xF0, 0x24, 0x33, 0x62, 0x72,
        0x82, 0x09, 0x0A, 0x16, 0x17, 0x18, 0x19, 0x1A,
        0x25, 0x26, 0x27, 0x28, 0x29, 0x2A, 0x34, 0x35,
        0x36, 0x37, 0x38, 0x39, 0x3A, 0x43, 0x44, 0x45,
        0xFF, 0xDA, 0x00, 0x08, 0x01, 0x01, 0x00, 0x00,
        0x3F, 0x00, 0x7B, 0x94, 0x11, 0x00, 0x00, 0x00,
        0x00, 0xFF, 0xD9,
    ])
    return base64.b64encode(raw).decode()


def _demo_prevention_packet() -> TelemetryPacket:
    return TelemetryPacket(
        camera_id="demo-cam-001",
        ts=datetime.now(timezone.utc),
        room_type="bedroom",
        bed_polygon=[[100, 100], [500, 100], [500, 400], [100, 400]],
        motion_energy=0.35,
        stillness_score=0.4,
        frames_jpeg_base64=_load_frames("prevention_frames"),
        person_present=True,
        trigger_kind=TriggerKind.PREVENTION_CHECK,
    )


def _demo_fall_packet() -> TelemetryPacket:
    return TelemetryPacket(
        camera_id="demo-cam-001",
        ts=datetime.now(timezone.utc),
        room_type="bedroom",
        bed_polygon=[[100, 100], [500, 100], [500, 400], [100, 400]],
        motion_energy=0.85,
        stillness_score=0.8,
        frames_jpeg_base64=_load_frames("fall_frames"),
        person_present=True,
        trigger_kind=TriggerKind.FALL_TRIGGER,
    )


@router.post("/prevention")
async def demo_prevention():
    """Trigger a prevention demo scenario."""
    packet = _demo_prevention_packet()
    result = await handle_prevention(packet)
    return {"demo": "prevention", **result}


@router.post("/fall")
async def demo_fall():
    """Trigger a fall incident demo scenario."""
    packet = _demo_fall_packet()
    result = await handle_incident(packet)
    return {"demo": "fall", **result}
